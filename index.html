<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <script src="coi-serviceworker.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>MetaV 3D 数字艺术馆</title>
    
    <script type="importmap">
        {
            "imports": {
                "three": "./js/three.module.js",
                "gaussian-splats-3d": "./js/gaussian-splats-3d.module.js"
            }
        }
    </script>
    <script type="text/javascript" src="js/util.js"></script>


    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-dim: #64748b;
            --border: #e2e8f0;
        }

        html {
            overflow-y: scroll; /* 始终保留滚动条空间，防止布局抖动 */
        }

        /* 当详情页打开时，视觉上隐藏滚动条但保留轨道宽度，避免布局变化 */
        html.hide-scrollbar {
            scrollbar-width: none; /* Firefox */
        }
        html.hide-scrollbar::-webkit-scrollbar {
            width: 0; /* Chrome/Safari */
            height: 0;
        }

        body {
            margin: 0;
            font-family: 'Inter', 'Microsoft YaHei', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            overflow-x: hidden;
        }

        nav {
            padding: 0 3%;
            height: 80px;
            display: flex;
            justify-content: space-between; 
            align-items: center;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            box-shadow: 0 1px 0 rgba(0,0,0,0.03);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo-text {
            font-size: 24px; /* 略微调大 */
            font-weight: 900;
            letter-spacing: 2px;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;

            /* 1. 多色炫彩渐变：包含紫色、蓝色、青色、紫色 */
            background: linear-gradient(
                45deg, 
                #ff00cc, 
                #3333ff, 
                #00ccff, 
                #3333ff, 
                #ff00cc
            );
            background-size: 300% 300%; /* 扩大背景尺寸让色彩过渡更丝滑 */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;

            /* 2. 组合动画：流光 + 呼吸缩放 */
            animation: 
                rainbow-flow 5s ease infinite,
                gentle-pulse 2s ease-in-out infinite;
            
            display: inline-block; /* 必须设置此项，缩放动画才生效 */
        }

        /* 炫彩流光动画：让颜色斜向流动 */
        @keyframes rainbow-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }


        .school-logo {
            height: 50px;
            width: auto;
            object-fit: contain;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px 40px 24px;
            box-sizing: border-box;
        }

        .grid {
            display: flex;
            flex-wrap: wrap;
            gap: 24px;
            align-items: flex-start;
        }

        .card {
            flex: 0 0 calc(25% - 18px);
            box-sizing: border-box;
            background: var(--card-bg);
            border: 1px solid rgba(16,24,40,0.06);
            cursor: pointer;
            transition: transform 180ms ease, box-shadow 180ms ease, border-color 180ms ease;
        }

        .card:hover {
            transform: translateY(-8px);
            border-color: var(--primary);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .card-preview {
            width: 100%;
            height: 200px;
            background: radial-gradient(#ffffff, #f1f5f9);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .card-info {
            padding: 18px 22px 22px 22px;
            font-size: 14px;
            line-height: 1.6;
            border-top: 1px solid rgba(16,24,40,0.04);
        }

        .card-tag {
            display: block;
            font-size: 12px;
            color: var(--primary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .card-info h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
            color: var(--text-main);
        }

        @media (max-width: 1100px) {
            .card { flex: 0 0 calc(33.333% - 16px); max-width: 340px; }
            .card-preview { height: 180px; }
        }

        @media (max-width: 820px) {
            .card { flex: 0 0 calc(50% - 12px); max-width: 520px; }
            .card-preview { height: 180px; }
        }

        @media (max-width: 480px) {
            .card { flex: 0 0 100%; max-width: 100%; }
            .card-preview { height: 160px; }
        }

        #detail-view {
            position: fixed;
            inset: 0;
            background: #000000;
            z-index: 2000;
            display: none;
        }

        #detail-view.active {
            display: block;
        }

        /* 锁定滚动：用 position:fixed 冻结页面，不会移除滚动条 */
        body.no-scroll {
            position: fixed;
            width: 100%;
            left: 0;
        }

        #main-viewer {
            width: 100%;
            height: 100%;
            background: #000000;
        }

        /* 内部动画容器：淡入上浮 */
        .detail-inner {
            position: absolute;
            inset: 0;
            opacity: 0;
            transform: translateY(12px) scale(0.998);
            transition: opacity 320ms cubic-bezier(.2,.8,.2,1), transform 320ms cubic-bezier(.2,.8,.2,1);
            will-change: opacity, transform;
        }

        .detail-inner.open {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .detail-inner.closing {
            opacity: 0;
            transform: translateY(12px) scale(0.998);
        }

        .back-btn {
            position: fixed;
            left: 22px;
            top: 30px;
            z-index: 3000;
            padding: 10px 18px;
            border-radius: 5px;
            background: rgba(255,255,255,0.92);
            border: 1px solid rgba(0,0,0,0.08);
            cursor: pointer;
            box-shadow: 0 6px 18px rgba(2,6,23,0.08);
            backdrop-filter: blur(6px);
            font-size: 14px;
            font-weight: 600;
        }

        .back-btn:hover {
            background: rgba(255,255,255,1);
            box-shadow: 0 8px 24px rgba(2,6,23,0.14);
        }

        /* 点击白色圆圈提示 */
        .click-ring {
            position: fixed;
            pointer-events: none;
            z-index: 2500;
            width: 40px;
            height: 40px;
            border: 2px solid rgba(255,255,255,0.9);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0.3);
            opacity: 1;
            animation: clickRingAnim 0.6s ease-out forwards;
        }
        .click-ring::after {
            content: '';
            position: absolute;
            inset: 6px;
            border: 1px solid rgba(255,255,255,0.5);
            border-radius: 50%;
        }
        @keyframes clickRingAnim {
            0%   { transform: translate(-50%, -50%) scale(0.3); opacity: 1; }
            50%  { transform: translate(-50%, -50%) scale(1.0); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(1.4); opacity: 0; }
        }
    </style>
</head>
<body>

    <nav>
         <div class="logo-text" onclick="window.location.href='/'">
            METAV<span style="margin: 0 2px;">•</span>3D
        </div>
        <img src="image/school.png" alt="云南师范大学信息学院" class="school-logo">
    </nav>

    <div class="container">
        <div class="grid" id="model-grid"></div>
    </div>

    <!-- 详情页：全屏 3D 查看器 -->
    <div id="detail-view">
        <div id="detail-inner" class="detail-inner">
            <button class="back-btn" id="back-btn">← 返回展厅</button>
            <div id="main-viewer"></div>
        </div>
    </div>

    <script type="module">
        import * as GaussianSplats3D from 'gaussian-splats-3d';
        import * as THREE from 'three';

        const models = [
            {
                name: "花束场景",
                category: "自然 / 植物",
                url: "./flower_cloud.ksplat",
                image: "./image/flower.png"
            },
            {
                name: "蝴蝶场景",
                category: "生物 / 昆虫",
                url: "./hudie_cloud.ksplat",
                image: "./image/hudie.png"
            },
            {
                name: "城市夜景",
                category: "城市 / 夜景",
                url: "./city_night_cloud.ksplat",
                
            },
            {
                name: "抽象艺术",
                category: "抽象 / 艺术",
                url: "./abstract_art_cloud.ksplat",
               
            },
                {
                    name: "太空星云",
                    category: "宇宙 / 天体",
                    url: "./space_nebula_cloud.ksplat",
                    
                },
                {
                    name: "海底世界",
                    category: "自然 / 海洋",
                    url: "./underwater_world_cloud.ksplat",
                    
                },
                    {
                        name: "机械零件",
                        category: "工业 / 机械",
                        url: "./mechanical_parts_cloud.ksplat",
                        
                    },
                    {
                        name: "幻想生物",
                        category: "幻想 / 生物",
                        url: "./fantasy_creature_cloud.ksplat",
                        
                    }
        ];

        let renderer, scene, camera, controls, renderableViewer, animationId, resizeHandler, clickHandler;

        function cleanupResources() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            if (resizeHandler) {
                window.removeEventListener('resize', resizeHandler);
                resizeHandler = null;
            }
            
            if (clickHandler) {
                const container = document.getElementById('main-viewer');
                container.removeEventListener('click', clickHandler);
                clickHandler = null;
            }
            
            if (renderableViewer && scene) {
                scene.remove(renderableViewer);
                renderableViewer = null;
            }
            
            if (controls) {
                controls.dispose();
                controls = null;
            }
            
            if (renderer) {
                const container = document.getElementById('main-viewer');
                container.innerHTML = '';
                renderer.dispose();
                renderer = null;
            }
            
            scene = null;
            camera = null;
        }

        function showDetail(model) {
            const container = document.getElementById('main-viewer');
            
            cleanupResources();

            // 先锁定滚动，记住当前滚动位置
            const scrollY = window.scrollY;
            document.body.style.top = `-${scrollY}px`;
            document.body.dataset.scrollY = scrollY;
            document.body.classList.add('no-scroll');
            // 隐藏视觉上的滚动条（但保留轨道宽度以避免布局抖动）
            document.documentElement.classList.add('hide-scrollbar');
            document.getElementById('detail-view').classList.add('active');

            renderer = new THREE.WebGLRenderer({ antialias: false });
            renderer.setPixelRatio(window.devicePixelRatio || 1);
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);

            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(
                65, 
                container.clientWidth / container.clientHeight, 
                0.1, 
                500
            );
            camera.position.set(-4, -0.2, -4);
            camera.lookAt(-26, 0.225, -0.543);
            camera.up.set(0, -1, 0).normalize();

            controls = new GaussianSplats3D.OrbitControls(camera, renderer.domElement);
            controls.rotateSpeed = 0.3;
            controls.maxPolarAngle = Math.PI * 0.75;
            controls.minPolarAngle = 0.01;
            controls.enableDamping = true;
            controls.dampingFactor = 0.035;

            renderableViewer = new GaussianSplats3D.RenderableViewer();
            scene.add(renderableViewer);
            renderableViewer.addScenesFromFiles([{ path: model.url }], true)
                .catch(err => console.error('加载模型失败:', err));

            resizeHandler = () => {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            };
            window.addEventListener('resize', resizeHandler);

            // 鼠标左键点击设置焦点（OrbitControls 的旋转中心）
            let mouseDownPos = null;
            let focusTween = null; // 动画过渡状态

            // 显示白色圆圈点击提示
            function showClickRing(x, y) {
                const ring = document.createElement('div');
                ring.className = 'click-ring';
                ring.style.left = x + 'px';
                ring.style.top = y + 'px';
                document.body.appendChild(ring);
                ring.addEventListener('animationend', () => ring.remove());
            }

            container.addEventListener('mousedown', (e) => {
                if (e.button === 0) mouseDownPos = { x: e.clientX, y: e.clientY };
            });
            clickHandler = (e) => {
                // 仅在鼠标未拖拽时触发（区分点击和拖拽）
                if (!mouseDownPos) return;
                const dx = e.clientX - mouseDownPos.x;
                const dy = e.clientY - mouseDownPos.y;
                if (Math.sqrt(dx * dx + dy * dy) > 5) return;

                // 显示白色圆圈提示
                showClickRing(e.clientX, e.clientY);

                const rect = renderer.domElement.getBoundingClientRect();
                const ndcX = ((e.clientX - rect.left) / rect.width) * 2 - 1;
                const ndcY = -((e.clientY - rect.top) / rect.height) * 2 + 1;

                // 从相机发射射线
                const raycaster = new THREE.Raycaster();
                raycaster.setFromCamera(new THREE.Vector2(ndcX, ndcY), camera);

                // 创建一个与相机视线垂直的平面，经过当前焦点
                const cameraDir = new THREE.Vector3();
                camera.getWorldDirection(cameraDir);
                const plane = new THREE.Plane().setFromNormalAndCoplanarPoint(cameraDir, controls.target);

                // 计算射线与平面的交点，平滑过渡到新焦点
                const hitPoint = new THREE.Vector3();
                if (raycaster.ray.intersectPlane(plane, hitPoint)) {
                    // 平滑动画过渡
                    const startTarget = controls.target.clone();
                    const startTime = performance.now();
                    const duration = 500; // 过渡时长 ms

                    // 取消之前的过渡动画
                    if (focusTween) cancelAnimationFrame(focusTween);

                    function tweenFocus(now) {
                        let t = Math.min((now - startTime) / duration, 1);
                        // ease-out cubic 缓动
                        t = 1 - Math.pow(1 - t, 3);
                        controls.target.lerpVectors(startTarget, hitPoint, t);
                        controls.update();
                        if (t < 1) {
                            focusTween = requestAnimationFrame(tweenFocus);
                        } else {
                            focusTween = null;
                        }
                    }
                    focusTween = requestAnimationFrame(tweenFocus);
                    console.log('焦点过渡到:', hitPoint.x.toFixed(3), hitPoint.y.toFixed(3), hitPoint.z.toFixed(3));
                }
            };
            container.addEventListener('click', clickHandler);

            function animate() {
                animationId = requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();

            // Animate inner content in
            const detailInner = document.getElementById('detail-inner');
            if (detailInner) {
                detailInner.classList.remove('closing');
                void detailInner.offsetWidth;
                requestAnimationFrame(() => detailInner.classList.add('open'));
            }
        }

        function hideDetail() {
            // 清理 3D 资源
            cleanupResources();

            // 重置 detail-inner 状态
            const detailInner = document.getElementById('detail-inner');
            if (detailInner) {
                detailInner.classList.remove('open');
                detailInner.classList.remove('closing');
            }

            // 隐藏详情页
            document.getElementById('detail-view').classList.remove('active');

            // 恢复滚动：先取消 fixed 定位，再恢复滚动位置
            const scrollY = parseInt(document.body.dataset.scrollY || '0');
            document.body.classList.remove('no-scroll');
            // 恢复视觉滚动条显示
            document.documentElement.classList.remove('hide-scrollbar');
            document.body.style.top = '';
            window.scrollTo(0, scrollY);
        }

        function initGrid() {
            const grid = document.getElementById('model-grid');
            models.forEach(model => {
                const card = document.createElement('div');
                card.className = 'card';
                const thumb = model.image || (() => {
                    const svg = `
                        <svg xmlns='http://www.w3.org/2000/svg' width='760' height='680'>
                            <rect width='100%' height='100%' fill='#eef2f7' />
                            <circle cx='650' cy='110' r='80' fill='#4fd6d0' fill-opacity='0.25'/>
                            <g font-family='sans-serif' fill='#334155'>
                                <text x='28' y='60' font-size='20' font-weight='700'>${model.name}</text>
                                <text x='28' y='90' font-size='14' fill='#64748b'>${model.category}</text>
                            </g>
                        </svg>`;
                    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
                })();
                
                card.innerHTML = `
                    <div class="card-preview"><img src="${thumb}" alt="${model.name}"></div>
                    <div class="card-info">
                        <span class="card-tag">${model.category}</span>
                        <h3>${model.name}</h3>
                    </div>
                `;
                card.onclick = () => showDetail(model);
                grid.appendChild(card);
            });
        }

        document.getElementById('back-btn').addEventListener('click', hideDetail);
        window.addEventListener('load', initGrid);
    </script>
</body>
</html>
